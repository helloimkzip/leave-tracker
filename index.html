<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸç´…è«‹å‡ç´€éŒ„ - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- å¼·åˆ¶é€£ç·šé…ç½® ---
        // é€™äº›é‡‘é‘°æ˜¯å…¬é–‹é€£ç·šæ‰€éœ€çš„ï¼Œæ‰‹å‹•å¡«å…¥ä»¥ç¢ºä¿åœ¨ GitHub Pages æ­£å¸¸é‹ä½œ
        const firebaseConfig = {
            apiKey: "", 
            authDomain: "generativelanguage.firebaseapp.com",
            projectId: "generativelanguage",
            storageBucket: "generativelanguage.appspot.com",
            messagingSenderId: "google-internal",
            appId: "google-internal"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // è¨­å®šå”¯ä¸€çš„ App IDï¼Œç¢ºä¿å¤§å®¶é€£åˆ°åŒä¸€å€‹è³‡æ–™åº«
        const appId = "leave-tracker-shared-v1"; 

        // ç‹€æ…‹ç®¡ç†
        let leaveData = {};
        let user = null;
        let currentDate = new Date();
        let chartInstance = null;

        // UI æç¤ºå‡½å¼
        const showToast = (msg) => {
            const toast = document.getElementById('toast');
            if(!toast) return;
            toast.innerText = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 2000);
        };

        // èªè­‰ç›£è½
        onAuthStateChanged(auth, async (u) => {
            if (!u) {
                try {
                    await signInAnonymously(auth);
                } catch (e) {
                    console.error("åŒ¿åç™»å…¥å¤±æ•—", e);
                    document.getElementById('userIdDisplay').innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
                }
            } else {
                user = u;
                document.getElementById('userIdDisplay').innerText = `é€£ç·šç‹€æ…‹ï¼šå·²é€£ç·š (ID: ${user.uid.substring(0,5)})`;
                setupRealtimeSync();
            }
        });

        // å³æ™‚åŒæ­¥é‚è¼¯
        const setupRealtimeSync = () => {
            if (!user) return;
            // å›ºå®šè·¯å¾‘ï¼š/artifacts/{appId}/public/data/leaveRecords/main
            const dataDoc = doc(db, 'artifacts', appId, 'public', 'data', 'leaveRecords', 'main');
            
            onSnapshot(dataDoc, (snapshot) => {
                if (snapshot.exists()) {
                    leaveData = snapshot.data().records || {};
                } else {
                    leaveData = {};
                }
                renderAll();
                // éš±è—è¼‰å…¥ä¸­æç¤º
                document.getElementById('currentMonthYear').classList.remove('animate-pulse');
            }, (error) => {
                console.error("åŒæ­¥å¤±æ•—:", error);
                document.getElementById('userIdDisplay').innerText = "é€£ç·šå—é˜»ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚";
            });
        };

        // å„²å­˜è‡³é›²ç«¯
        const saveToCloud = async (newRecords) => {
            if (!user) return;
            try {
                const dataDoc = doc(db, 'artifacts', appId, 'public', 'data', 'leaveRecords', 'main');
                await setDoc(dataDoc, { records: newRecords });
            } catch (error) {
                console.error("å„²å­˜å¤±æ•—:", error);
                showToast("é›²ç«¯å„²å­˜å¤±æ•—");
            }
        };

        // æ ¸å¿ƒæ¸²æŸ“å‡½å¼
        function renderAll() {
            renderCalendar();
            updateDashboard();
            updateReasonList();
            renderReasonRanking();
            updateDetailedStats();
        }

        window.renderCalendar = function() {
            const daysContainer = document.getElementById('calendarDays');
            const monthLabel = document.getElementById('currentMonthYear');
            if (!daysContainer || !monthLabel) return;

            daysContainer.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthLabel.innerText = `${year}å¹´ ${month + 1}æœˆ`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const lastDay = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'aspect-square';
                daysContainer.appendChild(empty);
            }

            for (let d = 1; d <= lastDay; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayEl = document.createElement('div');
                dayEl.className = 'aspect-square flex flex-col items-center justify-center rounded-xl border border-slate-100 cursor-pointer hover:bg-slate-50 transition-all relative text-sm font-medium';
                dayEl.innerHTML = `<span>${d}</span>`;

                const entry = leaveData[dateStr];
                if (entry) {
                    if (entry.status === 'am') dayEl.classList.add('leave-am');
                    else if (entry.status === 'pm') dayEl.classList.add('leave-pm');
                    else if (entry.status === 'full') dayEl.classList.add('leave-full');
                    if (entry.reason) {
                        const dot = document.createElement('div');
                        dot.className = 'absolute bottom-1 w-1.5 h-1.5 bg-red-400 rounded-full';
                        dayEl.appendChild(dot);
                    }
                }
                dayEl.onclick = () => openModal(dateStr);
                daysContainer.appendChild(dayEl);
            }
        }

        function updateDashboard() {
            let totalUsed = 0;
            Object.values(leaveData).forEach(e => totalUsed += (e.status === 'full' ? 1 : 0.5));
            const totalUsedEl = document.getElementById('totalUsed');
            if(totalUsedEl) totalUsedEl.innerText = totalUsed;
            
            const usage = (totalUsed / 30) * 100;
            const bar = document.getElementById('usageBar');
            const text = document.getElementById('usageText');
            if(bar) bar.style.width = `${Math.min(100, usage)}%`;
            if(text) text.innerText = `${Math.round(usage)}%`;
        }

        function updateDetailedStats() {
            let stats = { full: 0, am: 0, pm: 0 };
            let thisMonthCount = 0;
            const now = new Date();
            const monthPrefix = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;

            Object.entries(leaveData).forEach(([date, entry]) => {
                if (entry.status === 'full') stats.full++;
                else if (entry.status === 'am') stats.am++;
                else if (entry.status === 'pm') stats.pm++;
                
                if (date.startsWith(monthPrefix)) {
                    thisMonthCount += (entry.status === 'full' ? 1 : 0.5);
                }
            });

            document.getElementById('statFull').innerText = stats.full;
            document.getElementById('statHalf').innerText = stats.am + stats.pm;
            document.getElementById('statThisMonth').innerText = thisMonthCount;

            const chartEl = document.getElementById('leaveChart');
            if (chartEl) {
                const ctx = chartEl.getContext('2d');
                if (chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['å…¨å¤©', 'ä¸Šåˆ', 'ä¸‹åˆ'],
                        datasets: [{
                            data: [stats.full, stats.am, stats.pm],
                            backgroundColor: ['#ef4444', '#fee2e2', '#fecaca'],
                            borderWidth: 0
                        }]
                    },
                    options: { cutout: '70%', plugins: { legend: { display: false } } }
                });
            }
        }

        function updateReasonList() {
            const container = document.getElementById('recentReasons');
            const dates = Object.keys(leaveData).filter(d => leaveData[d].reason).sort((a,b) => new Date(b) - new Date(a)).slice(0,5);
            if (!dates.length) { container.innerHTML = '<p class="text-xs text-slate-400 italic text-center py-4">ç›®å‰å°šç„¡å‚™è¨»</p>'; return; }
            container.innerHTML = dates.map(d => `
                <div class="p-3 bg-red-50 rounded-lg border-l-4 border-red-400 transition hover:scale-[1.02]">
                    <p class="text-[10px] font-bold text-red-400">${d}</p>
                    <p class="text-sm text-slate-700">${leaveData[d].reason}</p>
                </div>
            `).join('');
        }

        function renderReasonRanking() {
            const container = document.getElementById('reasonRanking');
            const counts = {};
            Object.values(leaveData).forEach(e => { if(e.reason) counts[e.reason] = (counts[e.reason]||0)+1; });
            const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,5);
            if (!sorted.length) { container.innerHTML = '<p class="text-xs text-slate-400 italic text-center py-4">ç„¡çµ±è¨ˆæ•¸æ“š</p>'; return; }
            container.innerHTML = sorted.map(([r, c]) => `
                <div class="mb-3">
                    <div class="flex justify-between text-xs mb-1 text-slate-600"><span>${r}</span><b>${c}æ¬¡</b></div>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full"><div class="bg-red-400 h-full transition-all duration-500" style="width:${(c/5)*100}%"></div></div>
                </div>
            `).join('');
        }

        let activeDate = null;
        let activeStatus = '';

        window.openModal = (dateStr) => {
            activeDate = dateStr;
            const entry = leaveData[dateStr] || { status: '', reason: '' };
            activeStatus = entry.status;
            document.getElementById('modalDateTitle').innerText = dateStr;
            document.getElementById('modalReason').value = entry.reason || '';
            document.getElementById('editModal').classList.remove('hidden');
            updateModalButtons();
        };

        window.closeModal = () => document.getElementById('editModal').classList.add('hidden');
        window.setModalStatus = (s) => { activeStatus = s; updateModalButtons(); };

        function updateModalButtons() {
            const ids = { '': 'btnNone', 'am': 'btnAm', 'pm': 'btnPm', 'full': 'btnFull' };
            Object.values(ids).forEach(id => {
                const btn = document.getElementById(id);
                if(btn) btn.className = 'px-2 py-2 text-xs border rounded-lg hover:bg-slate-50';
            });
            const activeBtn = document.getElementById(ids[activeStatus]);
            if (activeBtn) activeBtn.className = 'px-2 py-2 text-xs border rounded-lg bg-red-500 text-white border-red-600';
        }

        window.saveModal = async () => {
            const reason = document.getElementById('modalReason').value.trim();
            const newRecords = { ...leaveData };
            if (!activeStatus) delete newRecords[activeDate];
            else newRecords[activeDate] = { status: activeStatus, reason: reason };
            await saveToCloud(newRecords);
            closeModal();
            showToast('é›²ç«¯å„²å­˜æˆåŠŸ');
        };

        window.changeMonth = (d) => { currentDate.setMonth(currentDate.getMonth() + d); renderCalendar(); updateDetailedStats(); };
        
        window.copyToClipboard = () => {
            const sorted = Object.keys(leaveData).sort();
            let text = "çœŸç´…è«‹å‡ç´€éŒ„åŒ¯ç¸½\n";
            sorted.forEach(d => text += `[${d}] ${leaveData[d].status} - ${leaveData[d].reason || 'ç„¡ç†ç”±'}\n`);
            const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            showToast('å·²è¤‡è£½ç´€éŒ„');
        };

        window.onload = () => { renderAll(); };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .leave-am { background: linear-gradient(to bottom right, #fee2e2 50%, transparent 50%); }
        .leave-pm { background: linear-gradient(to top left, #fecaca 50%, transparent 50%); }
        .leave-full { background-color: #ef4444 !important; color: white !important; }
        .modal-overlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-slate-200 pb-6">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">çœŸç´…è«‹å‡ç´€éŒ„</h1>
                <p id="userIdDisplay" class="text-xs text-slate-400 italic mt-1 font-medium">åˆå§‹åŒ–é›²ç«¯é€£ç·šä¸­...</p>
            </div>
            <button onclick="copyToClipboard()" class="bg-white border border-slate-200 text-slate-700 px-6 py-2.5 rounded-xl text-sm hover:bg-slate-50 transition shadow-sm font-bold">è¤‡è£½å®Œæ•´ç´€éŒ„</button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex flex-col justify-center text-center md:text-left">
                <p class="text-slate-400 text-xs font-bold uppercase mb-1 tracking-widest">å·²è«‹å‡ç¸½å¤©æ•¸</p>
                <div class="flex items-baseline justify-center md:justify-start gap-1">
                    <span id="totalUsed" class="text-5xl font-black text-slate-800">0</span>
                    <span class="text-slate-400 text-sm font-bold">DAYS</span>
                </div>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex flex-col justify-center md:col-span-2">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest text-[10px] md:text-xs">å¹´åº¦æ¶ˆè€—é€²åº¦ (30å¤©æ¨™ç«¿)</p>
                    <span id="usageText" class="text-lg font-black text-slate-800">0%</span>
                </div>
                <div class="w-full bg-slate-100 h-5 rounded-full overflow-hidden p-1">
                    <div id="usageBar" class="bg-red-500 h-full transition-all duration-1000 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 md:p-8">
                    <div class="flex items-center justify-between mb-8">
                        <h2 id="currentMonthYear" class="text-2xl font-black text-slate-800 animate-pulse">é€£ç·šä¸­...</h2>
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button onclick="changeMonth(-1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition text-slate-600">â†</button>
                            <button onclick="changeMonth(1)" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition text-slate-600">â†’</button>
                        </div>
                    </div>
                    <div id="calendarDays" class="grid grid-cols-7 gap-2 md:gap-3"></div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-8">
                    <h3 class="text-xl font-black text-slate-800 mb-6 flex items-center gap-2 text-sm md:text-xl">
                        <span class="w-2 h-6 bg-red-500 rounded-full"></span> æœ¬æœˆå‡åˆ¥çµ±è¨ˆ
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center">
                        <div class="relative w-32 h-32 mx-auto">
                            <canvas id="leaveChart"></canvas>
                        </div>
                        <div class="space-y-4 md:col-span-2 grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">å…¨å¤©</p>
                                <p class="text-xl font-black text-slate-800"><span id="statFull">0</span> æ¬¡</p>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">åŠå¤©</p>
                                <p class="text-xl font-black text-slate-800"><span id="statHalf">0</span> æ¬¡</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-2xl border border-red-100 col-span-2 text-center">
                                <p class="text-[10px] font-bold text-red-400 uppercase mb-1">ç•¶æœˆç´¯ç©</p>
                                <p class="text-3xl font-black text-red-600"><span id="statThisMonth">0</span> å¤©</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-white rounded-3xl p-6 md:p-8 border border-slate-100 shadow-sm">
                    <h3 class="font-black mb-6 text-slate-800 flex items-center gap-2">ğŸ’¬ è¿‘æœŸå‚™è¨»</h3>
                    <div id="recentReasons" class="space-y-4"></div>
                </div>
                <div class="bg-white rounded-3xl p-6 md:p-8 border border-slate-100 shadow-sm">
                    <h3 class="font-black mb-6 text-slate-800 flex items-center gap-2">ğŸ† æ’è¡Œ</h3>
                    <div id="reasonRanking" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å½ˆçª— -->
    <div id="editModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 md:p-8 border-b border-slate-50 flex justify-between items-center">
                <h3 id="modalDateTitle" class="text-2xl font-black text-slate-800"></h3>
                <button onclick="closeModal()" class="text-slate-300 hover:text-slate-600 transition text-2xl">âœ•</button>
            </div>
            <div class="p-6 md:p-8 space-y-6">
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setModalStatus('')" id="btnNone" class="p-3 text-xs font-bold border rounded-2xl">æ¸…ç©º</button>
                    <button onclick="setModalStatus('am')" id="btnAm" class="p-3 text-xs font-bold border rounded-2xl">ä¸Šåˆ</button>
                    <button onclick="setModalStatus('pm')" id="btnPm" class="p-3 text-xs font-bold border rounded-2xl">ä¸‹åˆ</button>
                    <button onclick="setModalStatus('full')" id="btnFull" class="p-3 text-xs font-bold border rounded-2xl">å…¨å¤©</button>
                </div>
                <textarea id="modalReason" rows="3" class="w-full border border-slate-100 rounded-2xl p-4 text-sm outline-none bg-slate-50 focus:bg-white focus:ring-4 focus:ring-red-50 transition" placeholder="è¼¸å…¥ç†ç”±..."></textarea>
            </div>
            <div class="p-6 md:p-8 bg-slate-50 flex gap-4">
                <button onclick="closeModal()" class="flex-1 p-4 text-sm font-bold bg-white text-slate-500 rounded-2xl border border-slate-200">å–æ¶ˆ</button>
                <button onclick="saveModal()" class="flex-1 p-4 text-sm font-black bg-red-600 text-white rounded-2xl shadow-lg shadow-red-100">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-8 py-4 rounded-2xl shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 pointer-events-none z-[100] font-bold text-sm"></div>
</body>
</html>
